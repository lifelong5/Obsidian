# 基于物理的渲染核心理论

## 微平面原理

## 能量守恒

## 基于F0的菲涅尔反射

反射光线与入射光线的比例，菲涅尔反射的关键参数在于每个微平面的法线与入射光线的夹角，而不是宏观平面的法向量和入射光线的角度。F0即0度角入射的菲涅尔反射率。任意角度的菲涅尔反射率可由F0和入射角度计算得出。

## 线性空间光照

## 色调映射

## 基于真实世界测量的材质参数

PBR的正统材质参数往往都是基于真实世界测量的，我们一般只对导体和电介质关注。

## 光照与材质解耦

相同的光照可以应用于所有物体和材质，无需传统光照模型所需的额外调整和hack。

# 渲染与人眼视觉：我们是如何看到周围的事物的？

我们看到的不是物体真正的颜色，是有色光中不能被物体吸收的颜色，即被散射或者是反射到我们眼睛里面可见光波长代表的颜色，才是我们感知到的物体的颜色。

![image-20221023223057232](C:\Users\huangxuemei\AppData\Roaming\Typora\typora-user-images\image-20221023223057232.png)

## 人类视觉系统：

![image-20221023223130683](C:\Users\huangxuemei\AppData\Roaming\Typora\typora-user-images\image-20221023223130683.png)

光线进入人眼，先穿过corneas角膜，然后经过pupil瞳孔，随后被lens晶状体折射到视网膜上，视网膜上的感光细胞感知到光线，最后生成视觉信号。波长越高的偏红，波长越低的偏蓝。

### 不同感光细胞对不同波长的可见光的敏感程度：

#### cones：

- Blue cones：对蓝色最敏感
- Green cones：对绿色最敏感
- Red cones：对红色最敏感

#### Rods：

虚线部分

![image-20221023223423477](C:\Users\huangxuemei\AppData\Roaming\Typora\typora-user-images\image-20221023223423477.png)

# 渲染与物理光线：

## 相速度与折射率：

在波动光学中，光被建模为一种电磁横波，即电场和磁场相互垂直的波。

![image-20221023224319041](C:\Users\huangxuemei\AppData\Roaming\Typora\typora-user-images\image-20221023224319041.png)

图中所示的波是最简单的光波。 它既是单色的（具有单一波长λ）又是线性极化的（电场和磁场各自沿单向振荡）。

### 相速度：

磁场矢量与电场矢量相互垂直，二者长度之比固定，该比率为相速度。

### 折射率：

光在传播到两种不同介质交界处时候，原始光波的相速度与新光波的相速度的比率定义为介质的光学性质，即为折射率。字母n表示。

## 复折射率：

表示介质将光能转为其他形式能量的吸收性。用k表示。n与k都与介质和光线有关，二者组成复数**n+ki**，称为**复折射率**。

### n（实部）：

度量了物质如何影响光速，即相对于真空中的光速减慢的度量

### k（虚部）：

确定了光在传播时候是否被吸收，转化为其他形式的能量，通常是热能，非吸收介质虚部为0；

*其中虚部是因为进入的光线的光波频率与介质中电子的振动频率所影响的，由于不同的原子和分子都具有不同的固定振动频率，所以介质会选择性的吸收光线中某些频率的部分*

对光线的吸收性会影响我们看到物体的颜色以及强度。

#### 物体的颜色：

![image-20221023231120235](C:\Users\huangxuemei\AppData\Roaming\Typora\typora-user-images\image-20221023231120235.png)

#### 颜色的强度：

![img](https://pic1.zhimg.com/80/v2-26ea263cc9ff1be05e9ad2f65966b1b8_720w.webp)

- 清水：吸收度为0，所以为透明的颜色。
- 石榴糖浆：吸收度对红色的吸收率低，所以为红色
- 茶：吸收度对棕色的波长的光线吸收低，所以未棕色。
- 咖啡：吸收对于红黄蓝的吸收率都比较低，所以为混合出的偏向黑色的颜色。

## 折射发生的条件：

**光在小于单一波长的距离内发生折射率的突然变化。**而折射率的缓慢变化不会导致光线的分离，而是会导致其传播路径的弯曲。当空气密度因温度而变化的时候，通常可以看到这种现象。

![image-20221024150556513](C:\Users\huangxuemei\AppData\Roaming\Typora\typora-user-images\image-20221024150556513.png)

## 物质对吸收和散射的特性组合决定其外观：

### 散射：决定材质的浑浊程度Scattering

如果材质中的颗粒越多，那么折射率发生变化的几率也就越大，材质表现的越浑浊

### 吸收：决定材质的外观颜色Absorption

几乎任何材质的外观颜色通常都是由其吸收的波长相关性引起的。

![img](https://pic3.zhimg.com/v2-d3ac5ac91eff21a435ecb067100ead0e_r.jpg)

*其实材质的外观还与光线的反射相关*

## 散射和吸收与观察尺度有关：

相同的介质，在小场景中的吸收和散射并不明显，但是在大场景中可能会展示出明显的吸收和散射。

# 渲染与几何光学：

## 光与介质边界的交互类型总结：

### 反射：

#### 镜面反射：

- 光在两种介质的交界面上的直接反射即为镜面反射。
- 镜面反射的光线占入射光线的比率可由菲涅尔方程计算得到
- 镜面反射的集中度由材质的粗糙度决定，如果材质的微平面越粗糙，那么每个微平面的镜面反射的光线的方向差别就越大，朝着某一个反射方向的光线就越少

### 折射：

#### 散射：折射率的快速变化引起散射

- 次表面散射：当观察像素小于散射距离时候，散射被称为次表面散射。
  - 透射：当光线进入材质再从材质中出来的现象，被称为透射，投射是次表面散射的特例
- 漫反射：当观察像素大于散射距离的时候，散射被称为漫反射。

#### 吸收：

![屏幕截图 2022-10-24 161716](C:\Users\huangxuemei\Desktop\屏幕截图 2022-10-24 161716.png)

## 不同物质与光的交互总结：

### 金属：

![image-20221024162032876](C:\Users\huangxuemei\AppData\Roaming\Typora\typora-user-images\image-20221024162032876.png)

### 电介质：

![image-20221024162810326](C:\Users\huangxuemei\AppData\Roaming\Typora\typora-user-images\image-20221024162810326.png)

### 半导体：

![image-20221024163034840](C:\Users\huangxuemei\AppData\Roaming\Typora\typora-user-images\image-20221024163034840.png)

## 微平面理论：

大多数真实世界的表面不是光学上光滑的，但是具有比光波长大得多但比像素小的尺度的不规则性。 这种微观几何（microgeometry）变化导致每个表面点反射（和折射）不同方向的光：材质的部分外观组成是这些反射和折射方向的聚合结果。

![img](https://pic3.zhimg.com/80/v2-5751f8c30efc2e87c0d6866b3ad60ae2_720w.webp)

**表面越粗糙，反射越模糊，因为每个微平面的反射光线的偏离越强。**

![img](https://pic2.zhimg.com/80/v2-a8a697e4bb8207c0bf1269957abb1df1_720w.webp)

## 菲涅尔反射：

### 菲涅尔效应：

表示的是看到的光线的反射率与视角相关的现象，其具体表现是在掠射角（与法线呈接近90度）下光的反射率会增加，也就是与法线的角度越大，反射率会越大。

![img](https://pic2.zhimg.com/80/v2-f2042ffb3d3fe234335d6f2610e051a5_720w.webp)

![img](https://pic4.zhimg.com/80/v2-e85747dfd982e4359c90a478778e4f17_720w.webp)

菲涅尔效应用于描述反射的强弱，当视线垂直于平面时，反射最弱，因为此时只有入射光线平行于表面的光线才能撞击眼睛，当不垂直于平面的时候，与平面的夹角越小，反射越强。

**我们在宏观层面看到的菲涅尔效应实际上是微观层面微平面菲涅尔效应的平均值。**不同材质的菲涅尔效应的强弱是不同的。

### 菲涅尔方程：

菲涅尔方程能解释反射光的强度、折射光的强度、相位与入射光的强度的关系。

入射角（入射光线与法线的夹角）x，菲涅尔反射率y：

**可以看出当入射角比较小的时候，入射角的变化对于菲涅尔反射率的影响较小，当入射角越大的时候，入射角的变化对于菲涅尔反射率的影响较大，并且入射角为90度的时候，菲涅尔反射率最大。**

**对于0°和45°之间的入射角，反射率几乎是恒定的。在45°和75°之间，反射率变化更为显着（通常但不总是有所增加）。最后，在75°和90°之间，反射率总是迅速变为1（白色，如果被视为一种颜色）。**

**所以我们可以将入射角为0度时候（垂直入射）的菲涅尔反射率F0作为材质的特征反射率，去对改物质的菲涅尔反射属性进行推测**

![img](https://pic1.zhimg.com/80/v2-653ec95132964d6cefbe5f15a5adf9bc_720w.webp)

### 从折射率中求得F0：

#### 折射率与F0的关系：

![image-20221024171038966](C:\Users\huangxuemei\AppData\Roaming\Typora\typora-user-images\image-20221024171038966.png)

n1和n2分别为两个介质的折射率，当n1为真空的折射率n=1时候，简化为：

![image-20221024171203818](C:\Users\huangxuemei\AppData\Roaming\Typora\typora-user-images\image-20221024171203818.png)

# 真实世界材质的渲染属性总结：

![image-20221024171749337](C:\Users\huangxuemei\AppData\Roaming\Typora\typora-user-images\image-20221024171749337.png)

# 常见材质F0反射率参考：

*我们一般使用的F0都是从空气进入该介质的F0，如果是从其他介质进入该材质的时候，需要对F0进行变换*

## 金属参考：

![img](https://pic2.zhimg.com/80/v2-0ea3d8db85f1a5cd77bd5d2828268fb5_720w.webp)

## 电介质：

![img](https://pic3.zhimg.com/80/v2-20dde6562a4d5373512e53676e512a2a_720w.webp)

## 半导体：

![img](https://pic3.zhimg.com/80/v2-18a596aa3f0f0c83f47c0f1aa701037e_720w.webp)